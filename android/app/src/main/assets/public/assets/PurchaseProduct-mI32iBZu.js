import{r as y,d as z,u as _,s as g,aF as E,aH as S,j as e,b as j,L as k,A}from"./index-BXWU0Hg5.js";const L=()=>{const[a,h]=y.useState(!1),{user:r,getSupabaseToken:n}=z(),{toast:s}=_();return{loading:a,initiatePurchase:async({materialId:t,materialTitle:i,price:l})=>{var p;if(!r)return s({title:"Authentication Required",description:"Please log in to purchase study materials",variant:"destructive"}),null;h(!0);try{const d=await n();if(!d)throw new Error("Authentication token not available");console.log("Initiating purchase for material:",t,"Price:",l);const{data:o,error:f}=await g.functions.invoke("create-razorpay-order",{headers:{Authorization:`Bearer ${d}`},body:{amount:l*100,currency:"INR",productId:t,productName:i,customerId:r.uid,customerEmail:r.email||r.phoneNumber||""}});if(f)throw console.error("Order creation error:",f),new Error(f.message||"Failed to create payment order");if(!o)throw new Error("No order data received from server");console.log("Razorpay order created:",o.id);const u=document.createElement("script");u.src="https://checkout.razorpay.com/v1/checkout.js",u.async=!0,document.body.appendChild(u),await new Promise((c,x)=>{u.onload=c,u.onerror=x});const w={key:"rzp_live_OCL24jX6vVdT6W",amount:o.amount,currency:o.currency,name:"Study Academy",description:`Payment for ${i}`,order_id:o.id,prefill:{name:(r==null?void 0:r.displayName)||((p=r==null?void 0:r.email)==null?void 0:p.split("@")[0])||"",email:(r==null?void 0:r.email)||"",contact:(r==null?void 0:r.phoneNumber)||""},handler:async function(c){var x;try{const v=await n(),P=await g.functions.invoke("verify-razorpay-payment",{headers:{Authorization:`Bearer ${v}`},body:{razorpay_payment_id:c.razorpay_payment_id,razorpay_order_id:c.razorpay_order_id,razorpay_signature:c.razorpay_signature,productId:t,userId:r.uid}});if(P.error)throw new Error(P.error.message||"Payment verification failed");if((x=P.data)!=null&&x.success)s({title:"Payment Successful!",description:"You now have access to the study material"}),window.location.href=`/material/${t}/access`;else throw new Error("Payment verification failed")}catch(v){console.error("Payment verification error:",v),s({title:"Payment Verification Failed",description:v.message||"Please contact support",variant:"destructive"})}},modal:{ondismiss:()=>{s({title:"Payment Cancelled",description:"You can try again anytime"})}},theme:{color:"#1e3a8a"}};return new window.Razorpay(w).open(),o}catch(d){return console.error("Purchase initiation error:",d),s({title:"Purchase Failed",description:d.message||"Unable to initiate purchase",variant:"destructive"}),null}finally{h(!1)}},checkPurchaseStatus:async t=>{if(!r)return!1;try{const{data:i,error:l}=await g.from("user_purchases").select("*").eq("user_id",r.uid).eq("material_id",t).maybeSingle();if(l)throw l;return!!i}catch(i){return console.error("Error checking purchase status:",i),!1}}}},q=()=>{const{productId:a}=E(),h=S(),{toast:r}=_(),{user:n}=z(),{loading:s,initiatePurchase:b,checkPurchaseStatus:N}=L(),[t,i]=y.useState(null),[l,p]=y.useState(!0),[d,o]=y.useState(!1);y.useEffect(()=>{u(),n&&a&&f()},[a,n]);const f=async()=>{if(n&&a){const m=await N(a);o(m)}},u=async()=>{if(!a){r({title:"Error",description:"Product ID is missing",variant:"destructive"}),h("/premium-materials");return}try{p(!0);const{data:m,error:c}=await g.from("study_materials").select("*").eq("id",a).eq("ispremium",!0).single();if(c)throw c;m?i(m):(r({title:"Not Found",description:"The requested product could not be found",variant:"destructive"}),h("/premium-materials"))}catch(m){console.error("Error fetching product details:",m),r({title:"Error",description:"Failed to fetch product details",variant:"destructive"}),h("/premium-materials")}finally{p(!1)}},w=async()=>{if(!n){r({title:"Authentication Required",description:"Please log in to purchase study materials",variant:"destructive"});return}t&&await b({materialId:t.id,materialTitle:t.title,price:t.price})};return l?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"text-center py-8",children:"Loading product details..."})}):t?e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx(j,{variant:"ghost",size:"icon",className:"mr-4",asChild:!0,children:e.jsx(k,{to:"/premium-materials",children:e.jsx(A,{className:"h-6 w-6"})})}),e.jsx("h1",{className:"text-2xl font-bold text-academy-primary",children:"Purchase Study Material"})]}),e.jsx("div",{className:"bg-white rounded-lg shadow-lg overflow-hidden",children:e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsx("div",{className:"md:w-1/3",children:e.jsx("img",{src:t.thumbnailurl||`https://via.placeholder.com/350x200/1e3a8a/ffffff?text=${encodeURIComponent(t.title)}`,alt:t.title,className:"w-full h-auto rounded-lg"})}),e.jsxs("div",{className:"md:w-2/3",children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:t.title}),e.jsx("p",{className:"text-gray-600 mb-4",children:t.description}),e.jsxs("div",{className:"border-t border-gray-200 pt-4 mt-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("span",{className:"text-lg font-medium",children:"Price:"}),e.jsxs("span",{className:"text-2xl font-bold",children:["₹",t.price]})]}),d?e.jsxs("div",{className:"bg-green-50 text-green-700 p-4 rounded-lg mb-4",children:["You have already purchased this material.",e.jsx(k,{to:`/material/${t.id}/access`,className:"block mt-2 text-blue-600 hover:underline",children:"View Material"})]}):e.jsx(j,{onClick:w,disabled:s,className:"w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-medium",children:s?"Processing...":`Pay ₹${t.price}`})]})]})]})})})]}):e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"text-center py-8",children:"Product not found"})})};export{q as default};
