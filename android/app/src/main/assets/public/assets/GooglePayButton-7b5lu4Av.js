import{d as E,u as S,r as h,s as f,j as n,b as T}from"./index-G_H0xwe1.js";const O=({paymentId:o,productId:s,amount:y,onSuccess:g,onError:d})=>{const{user:a}=E();S(),h.useEffect(()=>{o&&s&&a&&w()},[o,s,a]);const w=async()=>{try{const{data:i,error:u}=await f.from("study_materials").select("duration_months, duration_type").eq("id",s).single();if(u)throw u;let l=null;if(i.duration_type==="lifetime")l=null;else{const p=new Date,r=new Date(p);r.setMonth(r.getMonth()+(i.duration_months||12)),l=r.toISOString()}const{error:m}=await f.from("user_purchases").insert({user_id:a.uid,material_id:s,payment_id:o,amount:y,expires_at:l,purchased_at:new Date().toISOString()});if(m)throw m;g()}catch(i){console.error("Error recording purchase:",i),d(i instanceof Error?i.message:"Failed to record purchase")}};return null},B=({productId:o,productName:s,price:y,onSuccess:g,onCancel:d})=>{const{toast:a}=S(),[w,i]=h.useState(!1),[u,l]=h.useState(!1),[m,p]=h.useState(null),{user:r,getSupabaseToken:z}=E(),x="rzp_live_R8LCnQPRlQpF0s";h.useEffect(()=>{b()},[]);const b=async()=>{try{const e=document.createElement("script");e.src="https://checkout.razorpay.com/v1/checkout.js",e.async=!0,document.body.appendChild(e),e.onload=()=>{console.log("Razorpay script loaded successfully"),i(!0)},e.onerror=()=>{console.error("Error loading Razorpay script"),a({title:"Payment Error",description:"Failed to load payment system. Please try again later.",variant:"destructive"})}}catch(e){console.error("Error loading payment scripts:",e)}},R=async()=>{try{const e=await z();console.log("Creating Razorpay order with:",{amount:y*100,currency:"INR",productId:o,productName:s,customerId:r==null?void 0:r.uid,customerEmail:r==null?void 0:r.email,hasAuthToken:!!e});const{data:t,error:c}=await f.functions.invoke("create-razorpay-order",{body:{amount:y*100,currency:"INR",productId:o,productName:s,customerId:r==null?void 0:r.uid,customerEmail:r==null?void 0:r.email},headers:e?{Authorization:`Bearer ${e}`}:{}});if(c)throw console.error("Supabase function error:",c),new Error(`Order creation failed: ${c.message||JSON.stringify(c)}`);return console.log("Order created successfully:",t),t}catch(e){throw console.error("Error creating Razorpay order:",e),e}},j=async e=>{try{const t=await z(),{data:c,error:v}=await f.functions.invoke("verify-razorpay-payment",{body:{razorpay_payment_id:e.razorpay_payment_id,razorpay_order_id:e.razorpay_order_id,razorpay_signature:e.razorpay_signature,productId:o,userId:r==null?void 0:r.uid},headers:t?{Authorization:`Bearer ${t}`}:{}});if(v)throw v;return c}catch(t){throw console.error("Error verifying payment:",t),t}},k=async()=>{var e;if(!r){a({title:"Authentication Required",description:"Please log in to continue with the payment.",variant:"destructive"});return}if(!window.Razorpay){a({title:"Payment System Unavailable",description:"Please refresh the page and try again.",variant:"destructive"});return}try{l(!0),console.log("Starting Razorpay payment process...");const t=await R(),c={key:x,amount:t.amount,currency:t.currency,name:"Study Academy",description:`Payment for ${s}`,order_id:t.id,prefill:{name:r.displayName||((e=r.email)==null?void 0:e.split("@")[0])||"",email:r.email||"",contact:r.phoneNumber||""},handler:async P=>{try{if(console.log("Payment successful, verifying...",P),(await j(P)).success)p(P.razorpay_payment_id);else throw new Error("Payment verification failed")}catch(_){console.error("Payment verification error:",_),a({title:"Payment Verification Failed",description:"Please contact support if amount was deducted.",variant:"destructive"}),d()}},modal:{ondismiss:()=>{console.log("Payment modal dismissed"),l(!1)}},theme:{color:"#1e3a8a"}};new window.Razorpay(c).open()}catch(t){console.error("Error processing payment:",t),a({title:"Payment Failed",description:t.message||"There was an error processing your payment. Please try again.",variant:"destructive"}),d()}finally{l(!1)}},F=()=>{p(null),a({title:"Payment Successful",description:"Your payment has been processed successfully."}),setTimeout(()=>{const e=window.location.origin;window.location.href=`${e}/material/${o}/access?purchase=success`},1500),g()},A=e=>{p(null),a({title:"Payment Processing Error",description:e,variant:"destructive"}),d()};return n.jsxs(n.Fragment,{children:[n.jsx(T,{onClick:k,disabled:u||!w,className:"w-full bg-[#528FF0] hover:bg-[#4285f4] flex items-center justify-center gap-2 py-3 text-white",children:u?"Processing...":n.jsxs(n.Fragment,{children:[n.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:n.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z",fill:"white"})}),n.jsxs("span",{children:["Pay â‚¹",y]})]})}),m&&n.jsx(O,{paymentId:m,productId:o,amount:y,onSuccess:F,onError:A})]})};export{B as default};
