import{d as E,u as x,r as h,s as f,j as o,b as T}from"./index-BXWU0Hg5.js";const B=({paymentId:n,productId:i,amount:y,onSuccess:g,onError:d})=>{const{user:a}=E();x(),h.useEffect(()=>{n&&i&&a&&w()},[n,i,a]);const w=async()=>{try{const{data:s,error:u}=await f.from("study_materials").select("duration_months, duration_type").eq("id",i).single();if(u)throw u;let c=null;if(s.duration_type==="lifetime")c=null;else{const p=new Date,r=new Date(p);r.setMonth(r.getMonth()+(s.duration_months||12)),c=r.toISOString()}const{error:m}=await f.from("user_purchases").insert({user_id:a.uid,material_id:i,payment_id:n,amount:y,expires_at:c,purchased_at:new Date().toISOString()});if(m)throw m;g()}catch(s){console.error("Error recording purchase:",s),d(s instanceof Error?s.message:"Failed to record purchase")}};return null},O=({productId:n,productName:i,price:y,onSuccess:g,onCancel:d})=>{const{toast:a}=x(),[w,s]=h.useState(!1),[u,c]=h.useState(!1),[m,p]=h.useState(null),{user:r,getSupabaseToken:z}=E(),S="rzp_live_OCL24jX6vVdT6W";h.useEffect(()=>{b()},[]);const b=async()=>{try{const e=document.createElement("script");e.src="https://checkout.razorpay.com/v1/checkout.js",e.async=!0,document.body.appendChild(e),e.onload=()=>{console.log("Razorpay script loaded successfully"),s(!0)},e.onerror=()=>{console.error("Error loading Razorpay script"),a({title:"Payment Error",description:"Failed to load payment system. Please try again later.",variant:"destructive"})}}catch(e){console.error("Error loading payment scripts:",e)}},j=async()=>{try{const e=await z(),{data:t,error:l}=await f.functions.invoke("create-razorpay-order",{body:{amount:y*100,currency:"INR",productId:n,productName:i,customerId:r==null?void 0:r.uid,customerEmail:r==null?void 0:r.email},headers:e?{Authorization:`Bearer ${e}`}:{}});if(l)throw l;return t}catch(e){throw console.error("Error creating Razorpay order:",e),e}},R=async e=>{try{const t=await z(),{data:l,error:v}=await f.functions.invoke("verify-razorpay-payment",{body:{razorpay_payment_id:e.razorpay_payment_id,razorpay_order_id:e.razorpay_order_id,razorpay_signature:e.razorpay_signature,productId:n,userId:r==null?void 0:r.uid},headers:t?{Authorization:`Bearer ${t}`}:{}});if(v)throw v;return l}catch(t){throw console.error("Error verifying payment:",t),t}},k=async()=>{var e;if(!r){a({title:"Authentication Required",description:"Please log in to continue with the payment.",variant:"destructive"});return}if(!window.Razorpay){a({title:"Payment System Unavailable",description:"Please refresh the page and try again.",variant:"destructive"});return}try{c(!0),console.log("Starting Razorpay payment process...");const t=await j(),l={key:S,amount:t.amount,currency:t.currency,name:"Study Academy",description:`Payment for ${i}`,order_id:t.id,prefill:{name:r.displayName||((e=r.email)==null?void 0:e.split("@")[0])||"",email:r.email||"",contact:r.phoneNumber||""},handler:async P=>{try{if(console.log("Payment successful, verifying...",P),(await R(P)).success)p(P.razorpay_payment_id);else throw new Error("Payment verification failed")}catch(_){console.error("Payment verification error:",_),a({title:"Payment Verification Failed",description:"Please contact support if amount was deducted.",variant:"destructive"}),d()}},modal:{ondismiss:()=>{console.log("Payment modal dismissed"),c(!1)}},theme:{color:"#1e3a8a"}};new window.Razorpay(l).open()}catch(t){console.error("Error processing payment:",t),a({title:"Payment Failed",description:t.message||"There was an error processing your payment. Please try again.",variant:"destructive"}),d()}finally{c(!1)}},F=()=>{p(null),a({title:"Payment Successful",description:"Your payment has been processed successfully."}),setTimeout(()=>{window.location.href=`/material/${n}/access?purchase=success`},1500),g()},A=e=>{p(null),a({title:"Payment Processing Error",description:e,variant:"destructive"}),d()};return o.jsxs(o.Fragment,{children:[o.jsx(T,{onClick:k,disabled:u||!w,className:"w-full bg-[#528FF0] hover:bg-[#4285f4] flex items-center justify-center gap-2 py-3 text-white",children:u?"Processing...":o.jsxs(o.Fragment,{children:[o.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:o.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z",fill:"white"})}),o.jsxs("span",{children:["Pay â‚¹",y]})]})}),m&&o.jsx(B,{paymentId:m,productId:n,amount:y,onSuccess:F,onError:A})]})};export{O as default};
